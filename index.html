<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoDescribe — Online Object Detection</title>

    <!-- Bootstrap CSS (optional for buttons) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            background: #000;
            overflow-x: hidden;
        }

        /* Vanta background container */
        #vanta-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* Card container */
        .card-container {
            position: relative;
            z-index: 1; /* above background */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        /* Card styling */
        .card {
            width: 100%;
            max-width: 600px;
            margin: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-radius: 12px;
            background-color: rgba(255,255,255,0.95);
        }

        /* Overlay for bounding boxes */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Video and image preview */
        #cameraPreview, #photoResult {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }

        /* Instruction hint */
        #instructionHint {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            padding: 5px 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 5px;
            font-size: 0.9em;
            display: none;
        }

        /* Loading indicator */
        #loadingIndicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        /* Mobile responsiveness */
        @@media (max-width: 576px) {
            .card-container

        {
            padding: 10px;
        }

        .card {
            padding: 15px;
        }

        }
    </style>
</head>
<body>

    <!-- Background -->
    <div id="vanta-bg"></div>

    <!-- Card Container -->
    <div class="card-container">
        <div class="card p-3">
            <h1 class="mb-2">PhotoDescribe — Offline Object Detection</h1>
            <p class="text-muted">
                Open camera or upload photo → <b>take / preview</b> → analyze manually.
            </p>

            <!-- ACTION BUTTONS -->
            <div class="d-flex flex-wrap align-items-center gap-2 mt-3">
                <button id="btnOpenCam" class="btn btn-primary" disabled>Open Camera</button>
                <button id="btnTakePhoto" class="btn btn-primary" style="display:none">Take Photo</button>
                <button id="btnAnalyzePhoto" class="btn btn-success" style="display:none">Analyze Photo</button>
                <label class="btn btn-outline-secondary mb-0" style="cursor:pointer;">
                    Upload Photo
                    <input id="photoUpload" type="file" accept="image/*" hidden />
                </label>
                <div class="ms-auto d-flex align-items-center gap-1">
                    <input id="ttsToggle" type="checkbox" checked />
                    <span>Speak</span>
                </div>
            </div>

            <!-- ERROR MESSAGES -->
            <div id="errorMessages"
                 style="color:red; margin-top:10px; padding:10px; border:1px solid red;
                    background-color:#ffeaea; border-radius:5px; display:none;">
            </div>

            <!-- PREVIEW AREA -->
            <div class="position-relative mt-3" style="min-height:360px; width:100%;">
                <div id="instructionHint"></div>
                <video id="cameraPreview" autoplay playsinline style="display:none;"></video>
                <canvas id="overlay"></canvas>
                <img id="photoResult" style="display:none;" />
                <div id="loadingIndicator">
                    <span class="badge bg-warning text-dark px-3 py-2">Analyzing...</span>
                </div>
            </div>

            <!-- RESULT -->
            <div id="resultBox" class="mt-3 p-3 bg-light rounded" style="display:none; word-break:break-word;">
                <h2 class="h5">Detection Summary</h2>
                <p id="descriptionText" class="mb-0">...</p>
            </div>

            <canvas id="snapshotCanvas" style="display:none"></canvas>
        </div>
    </div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    <script>
        VANTA.NET({
            el: "#vanta-bg",
            color: 0x00ffff,
            backgroundColor: 0x000000,
            points: 15,
            maxDistance: 20,
            spacing: 15,
            showDots: true
        });
    </script>


<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>


    <script>

        const COCO_CLASSES = [
          "person","bicycle","car","motorcycle","airplane","bus","train","truck","boat",
          "traffic light","fire hydrant","stop sign","parking meter","bench",
          "bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe",
          "backpack","umbrella","handbag","tie","suitcase",
          "frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove",
          "skateboard","surfboard","tennis racket",
          "bottle","wine glass","cup","fork","knife","spoon","bowl",
          "banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake",
          "chair","couch","potted plant","bed","dining table","toilet","tv","laptop","mouse",
          "remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator",
          "book","clock","vase","scissors","teddy bear","hair drier","toothbrush"
        ];

        class AttributeAnalysisApp {

            constructor(config) {
                this.video = document.getElementById(config.videoId);
                this.overlay = document.getElementById(config.overlayId);
                this.ctx = this.overlay.getContext("2d");
                this.snapshotCanvas = document.getElementById(config.snapshotId);
                this.snapshotCtx = this.snapshotCanvas.getContext("2d");
                this.imgResult = document.getElementById(config.imageResultId);

                this.descriptionText = document.getElementById(config.descriptionTextId);
                this.resultBox = document.getElementById(config.resultBoxId);
                this.ttsToggle = document.getElementById(config.ttsToggleId);

                this.loadingIndicator = document.getElementById(config.loadingIndicatorId);
                this.errorMessages = document.getElementById(config.errorMessagesId);
                this.instructionHint = document.getElementById(config.instructionHintId);

                this.btnOpenCam = document.getElementById(config.btnOpenCamId);
                this.btnTakePhoto = document.getElementById(config.btnTakePhotoId);
                this.btnAnalyzePhoto = document.getElementById("btnAnalyzePhoto");
                this.photoUpload = document.getElementById(config.photoUploadId);

                this.stream = null;
                this.model = null;
                this.lastSpokenText = "";
            }

            async init() {
                try {
                    this.showLoading(true, "Loading AI model...");
                    this.model = await cocoSsd.load({ base: "lite_mobilenet_v2" });
                    this.showLoading(false);
                    this.btnOpenCam.disabled = false;
                    this.setupEvents();
                } catch {
                    this.showLoading(false);
                    this.showError("Failed to load AI model.");
                }
            }

            setupEvents() {
                this.btnOpenCam.onclick = () => this.toggleCamera();
                this.btnTakePhoto.onclick = () => this.takePhoto();
                this.btnAnalyzePhoto.onclick = () => this.analyzePhoto();
                this.photoUpload.onchange = e => this.handleUpload(e);
                window.onbeforeunload = () => this.stopCamera();
            }

            async toggleCamera() {
                this.stream ? this.stopCamera() : await this.startCamera();
            }

            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    this.video.srcObject = this.stream;
                    await new Promise(r => this.video.onloadedmetadata = r);

                    this.video.style.display = "block";
                    this.imgResult.style.display = "none";
                    this.overlay.style.display = "none";

                    this.btnTakePhoto.style.display = "inline-block";
                    this.btnAnalyzePhoto.style.display = "none";
                    this.btnOpenCam.textContent = "Close Camera";

                    this.showHint("Camera ready. Take a photo.");
                } catch {
                    this.showError("Camera access failed.");
                }
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(t => t.stop());
                    this.stream = null;
                }
                this.video.style.display = "none";
                this.btnTakePhoto.style.display = "none";
                this.btnOpenCam.textContent = "Open Camera";
            }

            takePhoto() {
                if (!this.stream) return;

                this.snapshotCanvas.width = this.video.videoWidth;
                this.snapshotCanvas.height = this.video.videoHeight;
                this.snapshotCtx.drawImage(this.video, 0, 0);

                this.imgResult.src = this.snapshotCanvas.toDataURL("image/jpeg", 0.9);
                this.imgResult.style.display = "block";

                this.stopCamera();

                this.btnAnalyzePhoto.style.display = "inline-block";
                this.resultBox.style.display = "none";

                this.showHint("Photo captured. Click Analyze Photo.");
            }

            handleUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                this.stopCamera();

                const reader = new FileReader();
                reader.onload = ev => {
                    this.imgResult.src = ev.target.result;
                    this.imgResult.style.display = "block";
                    this.btnAnalyzePhoto.style.display = "inline-block";
                    this.resultBox.style.display = "none";
                    this.showHint("Image ready. Click Analyze Photo.");
                };
                reader.readAsDataURL(file);
            }

            async analyzePhoto() {
                if (!this.imgResult.src) return;

                this.showLoading(true, "Analyzing image...");

                try {
                    const predictions = await this.model.detect(this.imgResult);

                    this.overlay.width = this.imgResult.naturalWidth;
                    this.overlay.height = this.imgResult.naturalHeight;
                    this.overlay.style.width = this.imgResult.style.width;
                    this.overlay.style.height = this.imgResult.style.height;
                    this.overlay.style.display = "block";

                    this.draw(predictions);
                    this.showResults(predictions);

                    this.showLoading(false);
                    this.showHint(null);
                } catch {
                    this.showLoading(false);
                    this.showError("Analysis failed.");
                }
            }

            draw(predictions) {
                this.ctx.clearRect(0, 0, this.overlay.width, this.overlay.height);
                this.ctx.strokeStyle = "#00E5FF";
                this.ctx.lineWidth = 3;
                this.ctx.font = "bold 16px Arial";

                predictions.forEach(p => {
                    const [x, y, w, h] = p.bbox;
                    this.ctx.strokeRect(x, y, w, h);

                    const label = p.class;
                    const tw = this.ctx.measureText(label).width;

                    this.ctx.fillStyle = "#00E5FF";
                    this.ctx.fillRect(x, y, tw + 8, 22);
                    this.ctx.fillStyle = "#000";
                    this.ctx.fillText(label, x + 4, y + 16);
                });
            }
        showResults(predictions) {
            const detectedSet = new Set(predictions.map(p => p.class));
            const detected = COCO_CLASSES.filter(c => detectedSet.has(c));

            let text;
            if (detected.length) {
                text = `Detected objects: ${detected.join(", ")}. `;
            } else {
                text = "No supported objects detected. ";
            }


            this.descriptionText.textContent = text;
            this.resultBox.style.display = "block";

            if (this.ttsToggle.checked && text !== this.lastSpokenText) {
                this.lastSpokenText = text;
                this.speak(text);
            }
        }


            speak(text) {
                try {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = "en-US";
                    window.speechSynthesis.speak(u);
                } catch {}
            }

            showLoading(show, msg = "") {
                if (!this.loadingIndicator) return;
                this.loadingIndicator.style.display = show ? "flex" : "none";
                if (show) this.loadingIndicator.querySelector("span").textContent = msg;
            }

            showError(msg) {
                if (!this.errorMessages) return;
                this.errorMessages.textContent = msg || "";
                this.errorMessages.style.display = msg ? "block" : "none";
            }

            showHint(msg) {
                if (!this.instructionHint) return;
                this.instructionHint.textContent = msg || "";
                this.instructionHint.style.display = msg ? "block" : "none";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            new AttributeAnalysisApp({
                videoId: "cameraPreview",
                overlayId: "overlay",
                snapshotId: "snapshotCanvas",
                imageResultId: "photoResult",
                descriptionTextId: "descriptionText",
                resultBoxId: "resultBox",
                ttsToggleId: "ttsToggle",
                loadingIndicatorId: "loadingIndicator",
                errorMessagesId: "errorMessages",
                instructionHintId: "instructionHint",
                btnOpenCamId: "btnOpenCam",
                btnTakePhotoId: "btnTakePhoto",
                photoUploadId: "photoUpload"
            }).init();
        });
    </script>


</body>
</html>




